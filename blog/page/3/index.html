
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>The Complaint of laoar</title>
	<meta name="author" content="Yafang Shao">

	
	<meta name="description" content="仅统计记录在案的，不过我看过的书和电影一般都会记录在豆瓣上，听过的音乐则比较多，只统计iPod里面听的次数较多的音乐。
&nbsp;
一 书 书名
豆瓣评分
我的评分 佛祖在一号线
8.4
3星 linux内核编程
无
3星 unix环境高级编程
9.5
5星 1949年后的梁漱溟（港版）
7. &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="The Complaint of laoar" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">The Complaint of laoar</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
<!--	<li><a href="/blog/archives">Archives</a></li> -->
	<li><a href="/aboutme">About laoar</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
<!--	<li><a href="/blog/archives">Archives</a></li> -->
	<li><a href="/aboutme">About laoar</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:laoar.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:laoar.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><meta content="width=device-width,user-scalable=no" name="viewport">





    
    
    <section class="archives"><h1 class="year">2014</h1>

<article>
    <h4 class="title"><a href="/blog/2014/05/25/hello-github/">Hello Github!</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/501">性能优化：一些很有意思的尝试</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blog/2014/05/20/test/">test</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/482">从linux内核里来学习性能优化，和一个例子</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/466">关于struct hack, 优雅的FreeBSD</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/455">关于Profiling</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/435">为什么发送segment fault信号的进程总是PID0 ？</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/422">我的2013</a></h4>
</article>
    




    
    
        </section>
    
    <section class="archives"><h1 class="year">2013</h1>

<article>
    <h4 class="title"><a href="/blogs/402">MacOS:mdworker曾让我很不爽</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/393">我为什么从华为离职</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/367">三言两语聊Kernel：linux kernel和bsd kernel实现doubly-linked list的差异</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/361">三言两语聊Kernel：atomic </a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/338">三言两语聊Kernel：该怎么理解Terminal</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/325">三言两语聊Kernel：从Linux到FreeBSD</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/316">在高铁上聊Kernel：what is the fucking ABI(程序二进制接口)?</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/299">三言两语聊Kernel：Busy Waiting or Sleeping？</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/289">三言两语聊Kernel：do{…}while(0)</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/269">三言两语聊kernel：调度入门</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/266">三言两语聊kernel：内存管理入门</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/250">三言两语聊kernel：线程栈</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/227">2012 memory</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/215">三言两语聊Kernel： Undefined Instruction</a></h4>
</article>
    




    
    
        </section>
    
    <section class="archives"><h1 class="year">2012</h1>

<article>
    <h4 class="title"><a href="/blogs/197">三言两语聊Kernel：flash驱动及文件系统</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/195">test</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/180">《捉虫日记》书评</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/133">我的阅读史</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/119">iPhoneOS浅浅浅浅析(4):不做学术派</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/112">iPhoneOS浅浅浅浅析（3）</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/91">iPhoneOS浅浅浅浅析（2）</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/79">iPhoneOS浅浅浅浅析</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/66">是闰土，还是马克？</a></h4>
</article>
    




<article>
    <h4 class="title"><a href="/blogs/3">hello world!</a></h4>
</article>
    
    </section>
    


<!--    <h4 class="title"><a href=""></a></h4>
&#8211;>
<!--



   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/227">
		
			2012 Memory</a>
	</h2>
	<div class="entry-content">
		<p><span>仅统计记录在案的，不过我看过的书和电影一般都会记录在豆瓣上，听过的音乐则比较多，只统计iPod里面听的次数较多的音乐。</span><br />
&nbsp;<br />
<h3>一 书</h3><br />
<table width="100%"><br />
<tbody><br />
<tr><br />
<th><strong>书名</strong></td><br />
<th><strong>豆瓣评分</strong></td><br />
<th><strong>我的评分</strong></td></p>
</tr>
<tr>
<td valign="top">佛祖在一号线</td>
<td valign="top">8.4</td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">linux内核编程</td>
<td valign="top">无</td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">unix环境高级编程</td>
<td valign="top">9.5</td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">1949年后的梁漱溟（港版）</td>
<td valign="top">7.3</td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">捉虫日记</td>
<td valign="top">无</td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">冰与火之歌（卷一）</td>
<td valign="top">9.4</td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">大话处理器</td>
<td valign="top">6.9</td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">大江大海1949</td>
<td valign="top">无</td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">linux/unix设计思想</td>
<td valign="top">7.7</td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">底层中国的缓慢革命</td>
<td valign="top">无</td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">影像中的文革农村</td>
<td valign="top">无</td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">这样事和谁细讲</td>
<td valign="top">无</td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">技术元素</td>
<td valign="top">8.4</td>
<td valign="top">3星</td>
</tr>
</tbody>
</table>
<div>5本技术类书籍，8本非技术类书籍（其中有5本是禁书）。</div>
<p>&nbsp;<br />
<h3>二 影（59部）</h3><br />
<div><br />
<table width="100%" border="1" cellspacing="0" cellpadding="2"><br />
<tbody><br />
<tr><br />
<th valign="top">电影/电视名</td><br />
<th valign="top">豆瓣评分</td><br />
<th valign="top">我的评分</td></p>
</tr>
<tr>
<td valign="top">亡命驾驶</td>
<td valign="top"><span style="color: #97248d;">7.1</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">三傻大闹宝莱坞</td>
<td valign="top"><span style="color: #053df5;">9.1</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">93航班</td>
<td valign="top"><span style="color: #97248d;">7.6</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">飞天大盗（第一季）</td>
<td valign="top"><span style="color: #ac784a;">8.9</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">锅匠、裁缝、士兵、间谍</td>
<td valign="top"><span style="color: #97248d;">7.8</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">总统杀局</td>
<td valign="top"><span style="color: #ff9132;">6.9</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">点球成金</td>
<td valign="top"><span style="color: #ac784a;">8.1</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">夺命金</td>
<td valign="top"><span style="color: #97248d;">7.1</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">谍中碟4</td>
<td valign="top"><span style="color: #ac784a;">8.1</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">龙门飞甲</td>
<td valign="top"><span style="color: #ff9132;">6.8</span></td>
<td valign="top">2星</td>
</tr>
<tr>
<td valign="top">我愿意</td>
<td valign="top"><span style="color: #ff1e18;">5.6</span></td>
<td valign="top">2星</td>
</tr>
<tr>
<td valign="top">齐达内：21世纪的肖像</td>
<td valign="top"><span style="color: #97248d;">7.4</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">战马</td>
<td valign="top"><span style="color: #97248d;">7.8</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">抢钱大作战</td>
<td valign="top"><span style="color: #97248d;">7.5</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">胡佛</td>
<td valign="top"><span style="color: #97248d;">7.0</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">一次别离</td>
<td valign="top"><span style="color: #ac784a;">8.8</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">兵临城下之决战要塞</td>
<td valign="top"><span style="color: #97248d;">7.6</span></td>
<td valign="top">2星</td>
</tr>
<tr>
<td valign="top">异星战场</td>
<td valign="top"><span style="color: #ff9132;">6.0</span></td>
<td valign="top">1星</td>
</tr>
<tr>
<td valign="top">晚秋</td>
<td valign="top"><span style="color: #ff9132;">6.6</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">春娇与志明</td>
<td valign="top"><span style="color: #97248d;">7.3</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">规则改变</td>
<td valign="top"><span style="color: #ac784a;">8.0</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">十加十</td>
<td valign="top"><span style="color: #97248d;">7.0</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">桃姐</td>
<td valign="top"><span style="color: #ac784a;">8.3</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">超级战舰</td>
<td valign="top"><span style="color: #ff9132;">6.5</span></td>
<td valign="top">1星</td>
</tr>
<tr>
<td valign="top">赛德克巴莱（上）</td>
<td valign="top"><span style="color: #ac784a;">8.7</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">复仇者联盟</td>
<td valign="top"><span style="color: #ac784a;">8.0</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">赛德克巴莱（下）</td>
<td valign="top"><span style="color: #ac784a;">8.4</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">赛德克巴莱（大陆版）</td>
<td valign="top"><span style="color: #ac784a;">8.5</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">黄金大劫案</td>
<td valign="top"><span style="color: #ff9132;">6.7</span></td>
<td valign="top">2星</td>
</tr>
<tr>
<td valign="top">北京爱情故事</td>
<td valign="top"><span style="color: #97248d;">7.3</span></td>
<td valign="top">1星</td>
</tr>
<tr>
<td valign="top">马达加斯加3</td>
<td valign="top"><span style="color: #ac784a;">8.3</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">画皮2</td>
<td valign="top"><span style="color: #ff1e18;">5.7</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">抓住外国佬</td>
<td valign="top"><span style="color: #97248d;">7.1</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">搜索</td>
<td valign="top"><span style="color: #97248d;">7.1</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">突袭</td>
<td valign="top"><span style="color: #97248d;">7.4</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">神探亨特张</td>
<td valign="top"><span style="color: #ff9132;">6.5</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">慕尼黑</td>
<td valign="top"><span style="color: #97248d;">7.6</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">麦兜当当伴我心</td>
<td valign="top"><span style="color: #ac784a;">8.3</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">精英部队2</td>
<td valign="top"><span style="color: #ac784a;">8.8</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">麦兜故事</td>
<td valign="top"><span style="color: #ac784a;">8.5</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">普罗米修斯</td>
<td valign="top"><span style="color: #97248d;">7.1</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">蝙蝠侠：黑暗骑士崛起</td>
<td valign="top"><span style="color: #ac784a;">8.4</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">浪潮</td>
<td valign="top"><span style="color: #ac784a;">8.7</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">飓风营救</td>
<td valign="top"><span style="color: #ac784a;">8.1</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">飓风营救2</td>
<td valign="top"><span style="color: #ff9132;">6.4</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">两杆大烟枪</td>
<td valign="top"><span style="color: #053df5;">9.1</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">从海底出击</td>
<td valign="top"><span style="color: #ac784a;">8.9</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">谍影重重4</td>
<td valign="top"><span style="color: #ff9132;">6.7</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">英国病人</td>
<td valign="top"><span style="color: #ac784a;">8.4</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">触不可及</td>
<td valign="top"><span style="color: #053df5;">9.0</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">莫扎特传</td>
<td valign="top"><span style="color: #ac784a;">8.6</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">汉密尔顿：国家利益</td>
<td valign="top"><span style="color: #ff9132;">6.5</span></td>
<td valign="top">5星</td>
</tr>
<tr>
<td valign="top">泰迪熊</td>
<td valign="top"><span style="color: #97248d;">7.0</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">加菲猫</td>
<td valign="top"><span style="color: #97248d;">7.4</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">少年派的奇幻漂流</td>
<td valign="top"><span style="color: #053df5;">9.1</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">我在伊朗长大</td>
<td valign="top"><span style="color: #ac784a;">8.7</span></td>
<td valign="top">4星</td>
</tr>
<tr>
<td valign="top">寒战</td>
<td valign="top"><span style="color: #97248d;">7.5</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">人在囧途之泰囧</td>
<td valign="top"><span style="color: #97248d;">7.9</span></td>
<td valign="top">3星</td>
</tr>
<tr>
<td valign="top">车轮不息</td>
<td valign="top"><span style="color: #053df5;">9.2</span></td>
<td valign="top">5星</td>
</tr>
</tbody>
</table>
</div>
<div></div>
<div>59部电影中，</div>
<div>豆瓣评分超过9分的：5部</div>
<div>豆瓣评分8~9的： 21部</div>
<div>豆瓣评分7~8的：22部</div>
<div>豆瓣评分6~7的：10部</div>
<div>豆瓣评分5~6的：2部（这两部都是在影院看的）</div>
<div>最低分：我愿意（5.6）</div>
<div>最高分：车轮不息（9.2）</div>
<div></div>
<div></div>
<div>我的评分：</div>
<div>5星： 12部</div>
<div>4星： 21部</div>
<div>3星： 20部</div>
<div>2星： 4部</div>
<div>1星： 3部（两部在影院看的科幻片，1部电视剧）</div>
<div></div>
<div>在影院看的：20部</div>
<p>&nbsp;<br />
<div></div><br />
<h3>三 音（Top39）</h3><br />
<div><!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><br />
<div>这39首歌曲中：</div><br />
<div>纯音乐：20首</div><br />
<div>摇滚： 8首</div><br />
<div>影视原声：6首</div><br />
<div>粤语：3首</div><br />
<div>国语：3首</div><br />
<div>英语：11首</div></p>
</div>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-01-01T00:00:00+08:00" pubdate data-updated="true">Jan 1<span>st</span>, 2013</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/215">
		
			三言两语聊Kernel： Undefined Instruction</a>
	</h2>
	<div class="entry-content">
		<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?-->    在写这篇文章的时候，我一直在犹豫要不要写， 因为它涉及到我的日常工作，而我司对信息安全监管的特别严。但是，我觉得最近遇到的这个bug确实很有趣，有必要记录一下，以后翻阅的时候也有参考。 所以，我禁掉了google对我个人博客的搜索，同时也关掉了往其他博客（比如sina微博）的同步。权当做个人记录。<br />
<div>     一个可执行文件，简单的看就是指令和数据的集合。 CPU在执行该可执行文件的时候，会不断的去读取指令，然后解析该指令，最终执行，这是流水线的基本原理。</div><br />
<div></div><br />
<div>    Undefined Instruction的意思就是，CPU无法解析从内存中读取到的指令，这条指令不是该CPU能够识别的指令集里面的。 出现undefined instruction，无非是以下几种情况：</div><br />
<div style="padding-left: 30px;">1）确实是非法指令</div><br />
<div style="padding-left: 60px;">这种情况一般都是硬编码导致，在代码里直接用16进制的数字来表示一条指令，这样就导致这些代码移植到其他平台的时候不能被解析。</div><br />
<div style="padding-left: 30px;">2）踩内存</div><br />
<div style="padding-left: 60px;">存储指令的内存空间被踩掉，指令就变成了其他的内容，这种情况，出现什么错误都是有可能的。不仅仅是undefined instruction，还可能是bad syscall等等。</div><br />
<div style="padding-left: 30px;">3）指令所在的内存被释放掉</div><br />
<div style="padding-left: 60px;">这种情况一般都是出现在操作系统里面。在操作系统初始化的时候，会执行很多初始化代码，这些代码在操作系统起来后就再也不被执行到了。为了节省内存，os就有了个机制：回收初始化代码，或者说，free init memory。一个函数使用__init memory机制的前提是，作者认为这部分代码以后永远也不会被用到。ok，问题就来了。 原作者很清楚自己写的代码，而后来的维护者就理解不是很深刻，他就可能会调用到__init memory里面的代码。可想而知，这必然是会出错的，因为init memory已经被释放然后分配给其他用途了，这个地址空间不知道存储的是什么东西，你再到这个地址空间去取指令，显然发生的错误是不可预料的。</div><br />
<div></div><br />
<div>    这三种情况我都有遇到过。 从定位问题的难度来看，感觉第3种是最好定位的，第2种是最不好定位的.下面我要说的就是遇到的第3种情况的问题。</div><br />
<div></div><br />
<div>    我在移植一个特性到os上去，执行的时候出现undefined instruction的情况，每次都是在func_a()这个出现。我就去看func_a()的反汇编，那个地址对应的指令是正常的。于是，我猜测应该是踩内存了。</div><br />
<div></div><br />
<div>    接下来，我在调用func_a()的前面加了几行语句，来把func_a()所在地址空间里面的内容给打印出来，看看到底是哪里被踩了。</div><br />
<div style="padding-left: 30px;">/<strong>打印出从func_a()所在地址开始的25条语句</strong>/</div><br />
<div style="padding-left: 30px;">for(i = (unsigned int)func_a; i &lt; (unsigned int)func_a + 100; i += 4 )</div><br />
<div style="padding-left: 30px;">     printk(&#8220;%08x : %08x\n&#8221;, (unsigned int)func_a, *(unsignd int *)func_a);</div><br />
<div></div><br />
<div>    打印出来的数据显示，func_a()这个函数里面的内容都被踩掉了。于是就去研究，为什么被踩。</div><br />
<div></div><br />
在追内核代码的过程中，发现func_a()这个函数其实是初始化部分的函数。函数定义如下：<br />
<div class='bogus-wrapper'><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="n">__init</span> <span class="nf">func_a</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>	<span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></div><br />
   __init这个宏的定义如下：<br />
<img src="/images/215.jpg"><br />
它的作用是，将这个函数放到.init.text这个section中。section是elf格式的一个概念，具体可google之。 os是怎么处理.init.text这个section的哪？<br />
<div></div><br />
    在free_initmem()这个函数里面会将这个section所占用的内存给释放掉：<br />
<img src="/images/215-2.jpg"><br />
注释：<br />
<div>1） __init_begin和__init_end的的初始化是在vmlinux.lds.S这个文件里面。 INIT_TEXT_SETION位于这两个变量之间。</div><br />
<div>2）INIT_TEXT_SETION的定义是在include/asm-generic/vmlinux.lds.h这个头文件中，就是.init.text这个节。</div><br />
<div></div></p>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-01-01T00:00:00+08:00" pubdate data-updated="true">Jan 1<span>st</span>, 2013</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/197">
		
			三言两语聊Kernel：flash驱动及文件系统</a>
	</h2>
	<div class="entry-content">
		<p style="text-align: left;">    flash分为nor flash和nand flash。nor flash的容量较小，但访问速度相对快；nand flash的容量较大。</p>
<p style="text-align: left;">    用户访问flash的内容大概是要经历这些过程：<br />
用户-＞vfs-＞具体文件系统-＞mtd设备（字符设备、块设备）-＞cfi命令字-＞flash。</p>
<p style="text-align: left;">    现在的flash一般都满足cfi标准，对于不满足cfi标准的flash要使用其他的命令字。</p>
<p>flash空间可根据需要来灵活划分分区，比如32M的flash，做如下划分：1M(uboot),2M(kernel),4M(initrd),25M(log)。注意划分分区的大小必须要是block大小的整数倍。分区划分可以通过uboot传参的方式来做， 这样更灵活一些，当然也可以直接写死在内核里面。使用uboot传参的方式需要内核mencuonfig的支持，即打开开关：CONFIG_CMDLINE_PARTS。打开了这个开关后，内核启动时就会解析uboot传递的参数：&quot;mtdparts=nor:1M(uboot),2M(kernel),4M(initrd),25M(log)&quot;。在内核启动时，只是会将这些分区划分信息给存储起来， 只有真正的加载flash驱动后，即通过cfi probe具体的flash并加载其ko，然后在会读取分区划分信息并对flash空间进行划分。划分好分区后，通过/proc/mtd可以看到这些分区。同时在/dev目录下能够看到对应的mtd设备（包括块设备和字符设备），由于我们是划分的4个分区，所以可以看到mtd0、mtd1、mtd2、mtd3这四个设备。我们可以通过open这几个设备来读写对应的flash地址空间。例：<br />
<div class='bogus-wrapper'><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/mtd3&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="err">“</span><span class="n">open</span><span class="err">”</span><span class="p">);</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">LEN</span><span class="p">)){</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="err">“</span><span class="n">write</span><span class="err">”</span><span class="p">);</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)){</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="err">“</span><span class="n">close</span><span class="err">”</span><span class="p">);</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nl">error:</span>
</span></code></pre></td></tr></table></div></figure></div></p>
<div>    通过mtd设备赖读写flash，这种方式会绕过文件系统层，即直接通过mtd接口来读写。这种方式和dd命令读写块设备是一致的，dd命令本质上也是用的这种方式， 比如我要随即产生1M大小的内容写入到mtd3对应的地址空间中可以这样：</div>
<div style="padding-left: 30px; text-align: center;">dd if=/dev/urandom of=/dev/mtdblock3 bs=128k count=8</div>
<div style="padding-left: 30px;"></div>
<div>     dd命令一般是用来测试flash的读写速度。</div>
<div style="text-align: left;">    上述这种方式，在内核里的执行路径大概是这样子：<br />
vfs_read/vfs_write-&gt;part_read/part_write-&gt;cfi_amdstd_read/do_write_buffer.</div>
<div style="text-align: left;">这种方式会绕过flash的具体文件系统，而是从vfs直接到mtd层。</div>
<div style="text-align: left;"></div>
<p>读写flash当然也可以使用/dev/mem的方式，/dev/mem是将外设的空间当做一块内存，然后mmap出来，这样就能直接在用户空间来操作物理地址。使用/dev/mem的示例如下：<br />
<div class='bogus-wrapper'><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">open</span><span class="p">(</span><span class="err">“</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mem</span><span class="err">”</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="o">|</span><span class="n">O_SYNC</span><span class="p">)){</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="err">“</span><span class="n">open</span><span class="err">”</span><span class="p">);</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">map_base</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span><span class="p">((</span><span class="n">map_base</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FLASH_SIZE</span><span class="p">,</span>  <span class="n">PROC_READ</span><span class="o">|</span><span class="n">PROC_WRITE</span><span class="p">,</span>
</span><span class='line'>            <span class="n">MAP_SHARED</span><span class="p">,</span>  <span class="n">fd</span><span class="p">,</span> <span class="n">FLASH_BASE</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="err">“</span><span class="n">mmap</span><span class="err">”</span><span class="p">);</span>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* get the content of the flash */</span>
</span><span class='line'><span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FLASH_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">map_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></div></p>
<p>使用/dev/mem的这种方式，不会调用驱动接口，它是直接把flash当做一块内存来使用，所以 /dev/mem这种方式破坏性很大。<br />
<div></div><br />
<div>     flash文件系统，现在主流的有jffs2、yaffs2、ubifs。jffs2适用于nor flash，yaffs2适用于nand flash，ubifs两种flash都适用。yaffs2目前还未进入内核主线。jffs2则很早就进入了内核主线，且在业界有相对较广泛的应用。ubifs是比较新的文件系统，在性能上显著优于其余两者，不过稳定性上目前还不太好。这三种flash文件系统各自的邮件列表貌似都不太活跃，通常是好几天才能收到一封邮件：）</div><br />
<div></div></p>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-12-16T00:00:00+08:00" pubdate data-updated="true">Dec 16<span>th</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/195">
		
			Test</a>
	</h2>
	<div class="entry-content">
		<p>testteste</p>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-12-16T00:00:00+08:00" pubdate data-updated="true">Dec 16<span>th</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/180">
		
			《捉虫日记》书评</a>
	</h2>
	<div class="entry-content">
		<p style="text-align: left;">    对于苦逼的IT男而言，对下面这个场景应该感到亲切。发出去的软件版本出现了bug，事情很紧急，于是大佬召集所谓一堆专家头脑风暴寻求解bug的思路，各路专家你一言我一语各抒己见，最终在众人齐心协力下，终于在最后关头定位出了根因。没有解不了的bug，只有不努力的coder。</p>
<p style="text-align: left;">    然而这个世界上还有另外一种人，他们也是解bug，只不过是找别人软件中的bug，他们通常被我们称之为hacker。</p>
<p style="text-align: left;">    同样是解bug，主动去找的就被称为黑客，被称作漏洞攻击，是人人都崇拜的行为艺术，就像街头弹吉他的青年歌手一样；而被动去定位的则被称为IT码农，被称作问题攻关，是人人都摇头的养家糊口，就像路边上拉二胡的老人一样。所以，不同的心态就会有不同的境界。凡事都要主动的好，这跟追女孩子是一个道理，美女身边有那么多人在追她，你不努力，美女怎么可能会想起你来哪？当然，你努力了，美女也未必会想起你来 ：）</p>
<p>    《捉虫日记》这本书的作者Tobias Klein就是那种可以被称之为hacker的人。作者热衷于找各个os的bug，这本书描述了作者找到的7个bug，他详细的记录了如何去寻找bug，以及如何利用这个bug，当然他也给出了每个bug的解决方案。像作者这种hacker，或者说geeker，应该会有twitter的，于是我翻墙搜了下，他的确开通了twitter，twitter账号是 @ tobiklein ，虽然作者是德国人，可是所发推文都是英文。可见，要想在twitter这个世界混的好，就得学会用英文，否则就只能在自己那个狭窄的母语圈来混了。而中文推特圈，则以狭隘、偏激而著称，至于原因，你懂的。Tobias Klein在10年3月31日发了一条推文“My new book just got released!”，指的就是这本书。至今为止Tobias Klein所发推文不多，从他的推文可以看出，他现在应该主要在研究iOS的bug。</p>
<p>下面是作者这本书里面7个例子的大致介绍。<br />
<p style="padding-left: 30px;">作者讲的第一个例子是个典型的栈缓冲区溢出（stack overflow）的例子。下面是个简单的stackoverflow示例程序。</p><br />
<p style="padding-left: 60px;"><strong>／*stackoverflow.c*／<br />
</strong><span style="color: #808000;">void overflow(char *argc)</span><br />
<span style="color: #808000;"> {    </span><br />
<span style="color: #808000;">    char buff<sup class="footnote" id="fnr8"><a href="#fn8">8</a></sup>;</span><br />
<span style="color: #808000;">     strcpy(buff, argc);</span><br />
<span style="color: #808000;"> }</span></p><br />
<p style="padding-left: 60px;"><span style="color: #808000;"> int main(int argc, char *argv[])</span><br />
<span style="color: #808000;"> {</span><br />
<span style="color: #808000;">     if(argc &gt; 1){</span><br />
<span style="color: #808000;">         overflow(argv<sup class="footnote" id="fnr1"><a href="#fn1">1</a></sup>);</span><br />
<span style="color: #808000;">     }</span><br />
<span style="color: #808000;">     return 0;</span><br />
<span style="color: #808000;">  }</span></p><br />
<p style="text-align: left;">     对于上面这个简单的程序，如果我们输入的数据长度大于8，就会发生栈缓冲区溢出。这里涉及的知识点有栈桢、数组。注意在linux下使用gcc来编译时要禁用gcc的堆栈保护才会stackoverflow，使用-fno-stack-protector编译选项。作者在twitter上也提到了几个stack overflow的bug，是iOS和MacOS的。看来栈缓冲区溢出这个bug太容易犯了，因为字符串操作函数strcpy()和strcat()很容易导致出错。这也是很多hacker热衷于寻找的一类bug。</p><br />
<p style="text-align: left;">    作者讲的第二个例子是solaris内核中内核态和用户态接口的一个bug。作者一直喜欢寻找操作系统内核漏洞，所以就拿solaris来开刀了，为什么不选择linux kernel哪？linux使用的人多，影响又大，而solaris则日薄西山了。对于操作系统而言，内核／用户态接口是最容易产生漏洞的地方。这些接口主要是以下几种：<br />
1）  ioctl<br />
2）  syscall<br />
3）  文件系统网络协议栈<br />
4）  第三方ko注册的钩子</p><br />
<p style="text-align: left;">    作者发现的一个bug是ioctl的bug。</p><br />
<p style="text-align: left;">    作者讲的第三个例子是空指针的一个bug。对于空指针，我想起一些工作上的事。有些新手经常问如何简单的让linux内核panic，我告诉他们访问一个null指针就好了。过了会，他们给我说，访问空指针的结果是segment fault，不是panic。我只好无奈的再解释，要写个ko，在内核态往null地址写数据就panic了，用户态出错，最多进程被杀死，是不会导致系统崩溃的。</p><br />
<p style="text-align: left;">    作者讲的第四个例子是浏览器ActiveX控件的一个bug。我对windows编程不太熟悉，此例不多言。</p><br />
<p style="text-align: left;">    作者讲的第五个例子是windows驱动的bug。用作者自己的话说，他想看看能不能在非开源的系统（比如windows）上找到bug。作者还特意把枪口瞄向了杀毒软件，真是大水冲龙王庙，自家人不认自家人啊。最终作者还真找到了bug，并通知给了杀毒软件厂商，他们及时的做了修复。</p><br />
<p style="text-align: left;">    第六个例子是MacOS的一个bug，看来作者是要通吃所有的操作系统啊。怪不得作者不找linux的麻烦，是嫌降低自己的身份啊！这个MacOS的bug依然是ioctl的bug，看来作者认定了所有os的ioctl都会有bug。</p><br />
<p style="text-align: left;">    最后一个例子是作者寻找iPhoneOS的bug，好吧，你赢了，你是真正的内核hacker。我只是一个内核码农，还只略微懂点linux的。</p><br />
<p style="text-align: left;">    虽然作者针对的是每个os的bug，但是这些bug都是最基础的编程问题。一招鲜吃遍天，只要你编程能力强，通吃所有的os只是你愿不愿意的问题。</p><br />
<p style="text-align: left;">    至于这本书的翻译，张伸，他也有twitter账号（@loveisbug），他竟然也是个足球迷。看在他是足球迷的份上，好吧，这本书翻译的挺好的。</p><br />
<p style="text-align: left;">    本来我是打算follow一下这位译者的，后来看到了它的一个推文，就不打算follow他了。他的推文是：“请教，a backtrace of all stack frames是什么意思？backtrace是函数调用栈吗？”。在这里回答译者一下：</p><br />
<p style="text-align: left;">    一个函数调用可以称之为一个栈帧，backtrace就是栈帧的集合，也就是函数调用栈。而缓冲区溢出（stack overflow）利用的的基本原理就是栈帧。使用gdb的bt命令就能够看出当前函数的调用栈。</p></p>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-10-03T00:00:00+08:00" pubdate data-updated="true">Oct 3<span>rd</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/133">
		
			我的阅读史</a>
	</h2>
	<div class="entry-content">
		<p>;<br />
<div>     我看的第一本小说是《鹿鼎记》，没错，是金庸的那本。大概是小学三四年级吧，反正记得那时候“鼎”字是通过查字典知道怎么念的。从这本小说开始，我的阅读人生就拉开了序幕，或者说，我的人生就此拉开了序幕。在我以后的整个阅读生涯中，都在努力的修正这个错误的第一次。<br />
<div>     小学时代给我印象最深刻的小说是儒勒凡尔纳的科幻小说《神秘岛》，不是原著，是针对小学生的特点做了些许改编的那本。这本书之所以给我留下深刻的印象，主要是由于它跌宕起伏充满悬念很惊险刺激的情节，还有一个原因是，里面的那些外国人名都比较简洁，没有什么帕帕斯塔索普洛斯、帕帕多普拉洛斯之类莫名其妙看的糊里糊涂的名字。这本改编本的故事性很强，很适合小孩看，如果那时候读原著的话，恐怕是看不下去的。后来还真特意找原著去看了，还真的看不下去，总觉得跟小时候看的那本相比欠缺些什么。</div><br />
<div>     你也许会觉得奇怪，我小学时候怎么净看这些长篇小说之类的。我也觉得奇怪，现在回想起来，小时候的人生确实是不太完整吧，就在别的孩子沉浸在连环画、童话大王、变形金刚葫芦娃的时候，我最喜欢看的竟然是故事会，当然不是前面的笑话十八则，而是后面那些讲述市井百态的文章。</div><br />
<div>     后来上了初中，脑袋瓜也被洗的差不多了，那时候满脑子的爱国爱党爱人民、中华民族伟大复兴之类的神圣思想。为了向苏联文学看齐，开始看些高尔基、托尔斯泰等人的著作，那个时候看俄国人写的书纯粹是为了显摆充面子，实际上那些书一点也看不下去。就说托尔斯泰的《复活》吧，我从来没有坚持连续看完一张过，是一张，不是一章，然后隔两三天再忍痛看不到一张，就这样也断断续续看了接近一半，剩下的那一半迄今也没有接着看，因为一看到复活这两个字就条件反射似的想吐。</div><br />
<div>     那个时候红色革命书籍也看了不少，像什么《红岩》啊之类的，现在一概没了印象，只记得看过。也看了些茅盾的钱钟书的老舍的鲁迅的曹禺的书，就记得钱钟书的《围城》文绉绉的，茅盾的某本书里面黄黄的。中国古典文学倒是看的较少，四大名著也只看了《西游记》，反正那么厚一本大部头，只记得吴承恩特别爱写诗，总是时不时的来个“有诗为曰…”。总之这些乌七八糟的书中，给我留下印象最深刻的是茅盾文学奖系列书中的《穆斯林的葬礼》和《平凡的世界》，那个时候看完《平凡的世界》后很感动，觉得中国最伟大的小说家应该是路遥。现在再来回忆那本书，觉得那只不过也是一部洗脑书，只是比较隐晦而已，主人公苦逼的童年和后来艰苦奋斗的成长史依然掩饰不了作者所宣扬的官本位思想，那不是中国梦，起码迄今为止都称不上是中国梦，而且不配称作中国梦，如果有。</div><br />
<div>     初中时的阅读史真的像龚自珍的《病梅馆记》，被扭曲的不成人形。感谢韩寒，把我从这个泥淖中给拉了出来。初二还是初三，不太记得了，韩少凭借他的《杯中窥人》一举成名天下知，惹得众多处于青春懵懂期的青少年开始看他的书。不过有点对不住韩少的是，看的他的第一本书是盗版的，《零下一度》和《三重门》的合集。看完《三重门》还没觉得什么，只是描写早恋罢了，正在发育中的孩子谁还没萌动过啊。真正给我冲击的是他的《零下一度》，现在还记得里面有篇文章是写中国足球的，什么什么中国国脚一脚趟出了底线什么什么张指导，觉得好玩急了，写的真是太风趣了。后来不知怎的，韩少好像销声匿迹了，我便再也没有看过他的书，大学期间才又开始看他写的博客。直至去年才算是买了他一本正版书《青春》，是一本杂文集，他这些年写的杂文我基本都看过，写的小说一本没读过。去年韩少被方舟子攻击，陷入代笔门、身高门、天才门等等各种门，大家各有各的看法，反正，韩少我挺你，起码为了你把我从红色革命中解救出来。</div><br />
<div>     顺理成章，到了高中时代我开始喜欢看杂文，经常买的一本杂志是《杂文选刊》。回忆高中，放佛是阅读缺失的时代。整个高中三年，基本没看过小说，只记得看了一本双语版的《三个火枪手》，是为了学英语。那个时候开始喜欢买报纸杂志，买的最多的是《杂文选刊》、《大科技》、《体坛周报》、《体育晨报》等，在紧张学习之余总会翻这些东西看看。那段时期迷恋过天体物理学，崇拜爱因斯坦、霍金，自然看了霍金的《时间简史》，谈不上看懂看不懂，纯粹是为了吹牛逼，我真正感兴趣的是《大科技》里面讲述黑洞的文章，饶有趣味。现在看来，《大科技》里面的文章幼稚极了。不知道这本杂志现在还出不出？倒闭了没？</div><br />
<div>     现在想来，高中时代最自豪事莫过于，晨读的时候在别人抱着课本一遍又一遍不厌其烦的背着唐诗宋词论语孟子的时候，我抽空念完了泰戈尔的《吉檀迦利》、《园丁集》、《飞鸟集》这三本诗集。还记得泰戈尔访华期间说过的一句话，“我走了，但我的心落在了这里”，现在还依然觉得这句话说的真是太有意境了。还记得泰戈尔和徐志摩一起访问过日本，还记得徐志摩的《沙扬娜拉》就是那段期间完成的。“最是你那一低头的温柔，像一朵水莲花，不胜凉风的娇羞”，不知道这句话被多少人曾经写在情书里，给那些年追过或者暗恋过的的女孩？</div><br />
<div>     十八周岁那年，闪亮亮的开始了我的大学生涯，或者说，开始了我的自理生涯。于是，我便不再看书了（不包括教材）。整个吊儿郎当的大学生涯浓缩为一句话：没翻过几本正儿八经的书。</div><br />
<div>      后来工作了，可能是有些无聊吧，就又开始看书了。最近这段时间看的一些书，不得不用此处省略若干字来代替。忽然记起和一个狐朋狗友的事，某天狐朋狗友甲发生了一件非常非常糗的事，我觉得非常非常搞笑，于是想写在微博里。甲兄弟说，可以写微博，但是发表之前必须得让他先看一遍。我一挥而就，洋洋洒洒140字写好了给他看。他看完之后说，AA改BB，CC改DD等等，完了还说我一点创作头脑都没有。可是按他说的修改后，就再也没有了那种韵味啊。尼玛，切身体会到了文化审查制度的坑爹处。</div><br />
<div>     所以，此处省略，应该有一万字…&#8230;</div><br />
&lt;/div</p>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-08-26T00:00:00+08:00" pubdate data-updated="true">Aug 26<span>th</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/119">
		
			iPhoneOS浅浅浅浅析(4):不做学术派</a>
	</h2>
	<div class="entry-content">
		<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?-->     回顾了一下我的前三篇文章，基本可以用这句话来概括：“我觉得这个问题可以怎么怎么样，但是我没搞定，当然，如果有时间有精力我一定能搞定”。这是典型的学术派思维。对于那些只说话不做事的“专家”而言，确实可以这说，但是对处于食物链底层的我等码农们而言，这是很不可取的。对于码农们而言，做要比说更重要，而不是那些天马行空的思维。对于专家们而言，则是说比做要重要。这个次序万万不可搞反了，不然下场会很惨。<br />
<div>     我现在天天研究iPhoneOS怎么样，MacOS又怎么样，整天一副自以为是的样子来指点江山</p>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-05-20T00:00:00+08:00" pubdate data-updated="true">May 20<span>th</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/112">
		
			iPhoneOS浅浅浅浅析（3）</a>
	</h2>
	<div class="entry-content">
		<p><!--?xml version="1.0" encoding="UTF-8" standalone="no"?-->     由于某司太过信息安全，当然我更多的是出于职业道德的考虑，既然拿了老板的钱，就要给老板赚钱，就不要损害老板的利益。所以，在我的个人博客上的技术文章从未涉及到我周一至周五每天早上9点至晚上八点四十埋头苦思的内容。这就好比，在武林大会上，一个剑客偏偏不能使剑，威力自然是大大打了折扣。所以，我这里的技术文章都显得很是小儿科，不要见怪。<br />
<div>     我这个系列叫做《iPhoneOS浅浅浅浅析》，但是，你会发现，这里面的内容和iPhone真是八竿子打不着。嗯，这个系列其实是写的mac，但是，你懂得，要标题党，不然吸引不了您的关注。呼呼。</div><br />
<div>     这篇文章就轻松愉悦一些。说一说mac一些很好玩的东西。</div><br />
<div>     众所周知，mac的应用程序比较匮乏，其娱乐性及实用性均被windows给甩出了几条街，其相比于windows唯一的优势便是它的标新立异，这也是我买mac的主要原因，好奇、新鲜感。其实用性差的地方不胜枚举，比如，我要通过网银给我妈寄钱，可惜没有mac下的网银客户端，没办法，只能打开我的thinkpad了。在日常娱乐中给我很不爽的是，下载电影很不方便，由于mac的浏览器是safari，我最常用的下载网站goxiazai就只能通过迅雷来下载电影，而该网站又不支持非IE内核调用迅雷。于是，我只好使用我的thinkpad下载电影，然后在mac上通过samba服务来访问thinkpad，然后使用mplayer来看下载的电影，在mac上看电影还是很炫的说。</div><br />
<div>     综上所述，不难发现，windows就像老婆，是每个男人必备的，而mac就像是小蜜，只能用来调剂情操。你可能觉得小蜜很是讨你欢心，但是关键时刻还得靠你老婆。</div><br />
<div>     既然mac电脑有如此多的粉丝，自然有它与众不同的地方。mac的touchpad就很个性化，它的touchpad是这样子的：</div><br />
<div><img src="webkit-fake-url://8B196E7A-8C0C-4FB3-BC01-E60AD10ED593/image.tiff" alt="" /></div><br />
<div>mac的touchpad仅仅是一个面板，没有左右按键，也没有侧边滑动框。简洁的才是最好的，这句话在这得到很充分的体现。虽然它没有这些东西，然而并不妨碍它有这些功能，mac用软件的方式来实现了在windows下需要硬件来完成的功能，而且，你一点也不会觉得麻烦，你会觉得使用起来非常的舒服。mac的touchpad是支持多点触摸的，两个手指同时按下就实现了鼠标右键的功能，两个手指同时滑动就实现了滑动的功能。它最多可以支持4个手指同时滑动，这也是很合理的，一个touchpad最多也就只能同时容纳四个手指嘛，四个手指同时滑动的效果就是misson control的功能。估计这种touchpad被apple申请了专利，所以windows机器才会使用那么丑陋的touchpad吧。</div><br />
<div>     mac电脑让我使用的最舒服的地方是它的misson control功能，就是F3按键的功能。我在电脑做一件事件时一般都是全屏操作，而有时候打开了很多东西，需要来回的切换，miss control就很方便的实现了我的这个需要。也许你会说windows的alt+tab同样可以，嗯，确实可以，不能否认比亚迪和兰博基尼都是汽车、都能开。</div><br />
<div>     对于技术宅没来说，mac最大的优点还是它的shell，yeah，你可以像linux一样使用mac。mac使用的是BSD的内核，和linux一样，都是由unix发展来的，所以mac和linux有很多相通的地方。MacOS的内核是darwin，darwin是一个混合内核，包括Mach 3微内核和FreeBSD组件。</div><br />
<div>    <a href="http://www.laoar.net/wp-content/uploads/2012/05/macos.jpg"><img class="alignnone size-full wp-image-114" title="macos" src="http://www.laoar.net/wp-content/uploads/2012/05/macos.jpg" alt="" width="441" height="220" /></a></div><br />
<div>Mach 提供了操作系统最重要的部分，它管理处理器资源比如CPU的使用、内存、调度、内存保护以及以消息传递为核心的进程间通信基础设施。 Darwin提供了一个面向对象的框架用来开发设备驱动，这个框架叫做I/O Kit. Darwin对BSD的应用包括很多POSIX API，上层应用程序可以通过这些接口来实现基本的应用程序功能。BSD为MacOS X的文件系统和网络设施提供基础的服务。<sup class="footnote" id="fnr1"><a href="#fn1">1</a></sup></div><br />
<div>     简单说下Darwin的历史。Darwin于1989年由NeXT公司发布（源码由Apple公司在2000年公开）。Darwin继承自NeXTSTEP（后来的OPENSTEP）操作系统。然而NeXT公司经营状况并不乐观，在1996年12月Apple花费4亿美金买下NeXT，Apple想要用NeXTStep来构成一个新的现代操作系统的基础，因为Apple当时的操作系统差得每当启动Netscape的Navigator的时候都会崩溃。从此NeXT技术进入Apple。Mac OS X Server 1.0应该才是开始以Darwin为核心开发的操作系统。</div><br />
<div>     Darwin有一个开源版本叫做OpenDarwin，OpenDarwin的计划是要为开源开发者提供资源来进行与Mac OS X的互动并为其生产产品。这个项目的其中一个主要方面就是使对Mac OS X感兴趣的开发者能够得到，修改，build并分发操作系统的变化。但是OpenDarwin这个项目最终over了，因为没有开发者参与进来。与此同时，GNU Darwin项目仍然继续。它的目标是创建一个基于Darwin的与Mac OS X兼容的操作系统，而不使用像CoreAudio 和CoreVideo这样的Mac OS X私有库.</div><br />
<div><span style="color: #333333; font-family: Verdana, Arial, Helvetica, sans-serif, 宋体;">     Darwin源码是用svn进行管理的，其地址为：</span><a href="http://svn.macosforge.org/repository/darwinbuild/trunk/">http://svn.macosforge.org/repository/darwinbuild/trunk/</a> 。 使用svn co <a href="http://svn.macosforge.org/repository/darwinbuild/trunk/"><span style="color: #000000;">http://svn.macosforge.org/repository/darwinbuild/trunk/</span></a> 将其check到本地后，会发现它是一个xcode工程。使用xcode将其打开后如下所示：</div><br />
<div><a href="http://www.laoar.net/wp-content/uploads/2012/05/xcode.png"><img class="alignnone size-full wp-image-115" title="xcode" src="http://www.laoar.net/wp-content/uploads/2012/05/xcode.png" alt="" width="271" height="260" /></a></div><br />
<div>      <img src="file:///Users/apple/Library/Application%20Support/Evernote/data/101370/content/p44/6623446244f97c3e00f52d67afd1d6d5.png" alt="" /></div><br />
<div>具体分析，详见下回分解&#8230;</div><br />
<div> </div><br />
<div><sup class="footnote" id="fnr1"><a href="#fn1">1</a></sup><a href="https://developer.apple.com/library/mac/#documentation/MacOSX/Conceptual/OSX_Technology_Overview/SystemTechnology/SystemTechnology.html">https://developer.apple.com/library/mac/#documentation/MacOSX/Conceptual/OSX_Technology_Overview/SystemTechnology/SystemTechnology.html</a></div><br />
<div> </div></p>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-05-13T00:00:00+08:00" pubdate data-updated="true">May 13<span>th</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/91">
		
			iPhoneOS浅浅浅浅析（2）</a>
	</h2>
	<div class="entry-content">
		<div>继续（1）的计划，我在MacOS上需要一个反汇编工具。我想比较一下gcc和llvm-gcc编译出来的东西到底有何不同。于是我进行了如下的尝试：</div>
<div>1）Port binutils to MacOS</div>
<div>     很不幸的是，由于我对xcode这个工具还不是很熟悉，而我又是借助xcode来编译的，所以在我configure的时候就失败了。然后我一点点的尝试修改binutils的源码，可是越改错误越多。当然，错误的原因肯定不是因为binutils，很可能是因为我没有使用好xcode。</div>
<div>2）单独编译objdump如何？</div>
<div>     我简单看了下objdump的源码，就一个源文件objdump.c, 看样子不是很复杂，这个源文件的代码行是3600行。但是由于用到了binutils的一些公共数据结构，比如bfd，所以肯定是不能单独编译的，需要和其他源文件一起编译才可以，如果将objdump.c所需要的头文件源文件给剥离出来制作一个Makefile，最终编译生成一个objdump，简单的分析一下它的工作量，objdump.c包含的头文件如下：</div>
<div><a href="http://www.laoar.net/wp-content/uploads/2012/05/includd2.png"><img class="alignnone size-full wp-image-105" title="includd" src="http://www.laoar.net/wp-content/uploads/2012/05/includd2.png" alt="" width="334" height="580" /></a></div>
<div><img src="file:///Users/apple/Library/Application%20Support/Evernote/data/101370/content/p34/94a31eed30c08bdae9d9f757b533bd4d.png" alt="" name="en-media:image/png:94a31eed30c08bdae9d9f757b533bd4d:none:none" /></div>
<div>     如果要剥离objdump，肯定是行得通的，但是工作量应该会很大。</div>
<div>3）xcode有木有？</div>
<div>     答案是：NO。 至少我没有找到。 xcode太过封闭了，似乎只能编译cococa框架的程序，如果编译一个简单的helloworld都不知道该怎么搞。VC也没有这么变态啊。</div>
<div> </div>
<div>于是这件事就被搁置了，再加上平实工作忙，周末又没有时间研究，所以一直脱啊脱啊脱。后来，我发现gdb也是可以反汇编可执行文件的！</div>
<div>ok。那就借助gdb来搞吧。下面是一些很粗略的分析。只是比较gcc和llvm-gcc的反汇编代码到底有和不同。至于二者孰优孰劣，在以后会继续研究的。</div>
<div> </div>
<div>对于一个简单的helloworld程序，</div>
<div>gcc编译生成的a.out的反汇编代码如下:</div>
<div><a href="http://www.laoar.net/wp-content/uploads/2012/05/23.png"><img class="alignnone size-full wp-image-107" title="2" src="http://www.laoar.net/wp-content/uploads/2012/05/23.png" alt="" width="833" height="416" /></a></div>
<div>llvm-gcc编译生成的a.out的反汇编代码如下：</div>
<div><a href="http://www.laoar.net/wp-content/uploads/2012/05/5.png"><img class="alignnone size-full wp-image-110" title="5" src="http://www.laoar.net/wp-content/uploads/2012/05/5.png" alt="" width="837" height="592" /></a></div>
<div>     可以发现，gcc编译的可执行文件的main函数部分有7条指令，而llvm-gcc编译出来的可执行文件的main函数部分有13条指令。两个最大的区别是对return 0;这条语句的处理不同。函数的返回值都是放在eax(或ax)这个寄存器中。gcc只是简单的mov 0 to eax就搞定了这件事。而llvm-gcc则处理的很复杂：先是将0放入rbp-8这个位置，再将rbp-8里面的值（即0）放入ecx，然后将ecx的值放入rbp-4，接着将eax的值放入放入rbp-0xc，最后将rbp-4的值放入eax，其效果也是将0放入eax。</div>
<div>     mov rsp to rbp的作用是，在函数开始执行的时候，将函数的栈底和栈顶赋值为相同。llvm-gcc多了条指令，将rsp指针减去0x10，即空出16个字节，空出这些字节的作用就是前面所属的针对mov 0 to eax的一系列操作。至于为什么将return 0 处理的这么复杂， 其作用到底何在，现在还没有搞的很明白，隐约的觉得是为了保护eax寄存器中原来的值（原来的值不就是传递给该函数的参数嘛，有必要保护嘛？）</div>
<div> </div>
<div>再来看一组涉及到计算的对比：</div>
<div>gcc:</div>
<div><a href="http://www.laoar.net/wp-content/uploads/2012/05/3.jpg"><img class="alignnone size-full wp-image-100" title="3" src="http://www.laoar.net/wp-content/uploads/2012/05/3.jpg" alt="" width="600" height="661" /></a></div>
<div><img src="file:///Users/apple/Library/Application%20Support/Evernote/data/101370/content/p34/b5835493cc65c9133d286a249a18a492.jpeg" alt="" name="en-media:image/jpeg:b5835493cc65c9133d286a249a18a492:none:none" /></div>
<div>llvm-gcc:</div>
<div><img src="file:///Users/apple/Library/Application%20Support/Evernote/data/101370/content/p34/52d274c41d5bd723f463772aabf35a87.png" alt="" name="en-media:image/png:52d274c41d5bd723f463772aabf35a87:none:none" /></div>
<div> <a href="http://www.laoar.net/wp-content/uploads/2012/05/42.png"><img class="alignnone size-full wp-image-99" title="4" src="http://www.laoar.net/wp-content/uploads/2012/05/42.png" alt="" width="616" height="682" /></a></div>
<div>     llvm-gcc同样比gcc要执行更多的指令，还有一个区别是，在计算过程中llvm-gcc值用到了eax这一个寄存器，而gcc用到了eax， edx两个寄存器。</div>
<div> </div>
<div>     更多深入的分析，稍后继续&#8230;</div>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-05-09T00:00:00+08:00" pubdate data-updated="true">May 9<span>th</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div>
</article>  


   <article class="post">
	<h2 class="title">
		
		<a href="/blogs/79">
		
			iPhoneOS浅浅浅浅析</a>
	</h2>
	<div class="entry-content">
		<div>在hi3ms上看到李大牛写的一篇关于ios的文章，那篇文章我没有细看，整篇文章我只记住一句话：＂由于公司没有mac电脑，只能在家里分析，所以进展会很慢。＂就是因为这句话，才让我对它写的那篇文章刮目相看，这说明那篇文章是他从实践得到的，而不是复制粘贴或者简单的翻译。于是我给李大牛留了言。</div>
<div>     我：MacOS的kernel不是开源的，又没有sysfs，也没有binutils，分析工具只能用xcode，所以大牛你介绍一下你的分析方法呗。</div>
<div>     李大牛：kernel就对照darwin kernel，分析工具就用xcode，我没有使用gcc。</div>
<div>     我：那，大牛你在mac下是如何浏览代码的？有没有类似SourceInsight的工具。</div>
<div>     李大牛：用什么SourceInsight，简直弱爆了，我都是使用vim+vtags+csope。</div>
<div>     我：（汗）…</div>
<div>     通过与李大牛的短短几行交流，我收获到一点：可以借助分析darwin kernel来分析iPhoneOS。另外，我觉得，大牛也不过尔尔。</div>
<div>     ok，我之前也一直打算研究一下MacOS。我的思路是这样的，首先我要整一套分析工具，包括gcc、binutils、glibc。然后借助这些工具看看能否把linux下的常用工具都给在mac下编译。最后，再分析MacOS kernel代码。</div>
<div>     在mac下，编译工具是xcode，xcode的sdk也不是很简单，安装好xcode之后，它的目录结构大致是这样子的：</div>
<div><a href="http://www.laoar.net/wp-content/uploads/2012/05/c89d49078ce418ab7c218b780cafdc4a2.png"><img class="alignnone size-full wp-image-83" title="c89d49078ce418ab7c218b780cafdc4a" src="http://www.laoar.net/wp-content/uploads/2012/05/c89d49078ce418ab7c218b780cafdc4a2.png" alt="" width="955" height="170" /></a></div>
<div><!--?xml version="1.0" encoding="UTF-8" standalone="no"?-->      Xcode包括三个SDK：mac、iPhone、iPhoneSimulator。（为何没有iPad？它和iPhone是一样滴，都是iOS嘛）</div>
<div>     对于一个编译环境而言，有三个最基本的东西：编译器、二进制分析工具、库。我在Xcode里面找到了MacOS和iPhoneOS的编译器和库，很可惜没有找到binutils。另外很遗憾的是，他们的编译器使用的是llvm-gcc，而不是gcc。需要提醒您的是，千万不要小瞧llvm-gcc，它是最大最好的开源项目，在它面前，GNU只有流汗的份。至于Apple与GNU的恩怨史，请Google之。</div>
<div>     明白了Xcode后，我的计划是，我可以使用Xcode的库函数（都是基本的C库函数，满足C99标准，跨平台的），我要做出mac上的gcc，再做出来bintuils尤其是其中的readelf和objdump，不然实在难以进行实质性的分析。我之所以不选择llvm-gcc，是因为我不太熟悉这个工具，所以我还要借助反汇编工具objdunp来分析一下llvm-gcc和gcc编译出来的二进制文件到底有何不同。</div>
<div>     Windows操作系统只有几千人开发，linux则有数万人做开发，但很可惜，linux远远不如windows强大。原因何在？搞linux的人不团结，你玩你的，我玩我的，版本那是玲琅满目，这就导致了大量的重复性劳动。嗯，你知道我要说什么。先google下看看有没有搞出来了Mac平台下的gcc和binutils。我在Sourceforge上找到了别人已经做出来的gcc：<a href="http://sourceforge.net/projects/hpc/files/hpc/gcc/">http://sourceforge.net/projects/hpc/files/hpc/gcc/</a> 。很可惜，没有找到binutils。那就自己来搞binutils吧。</div>
<div>     下载下来gcc后，由于它里面只有gcc，没有头文件也没有库，所以自然是无法编译helloworld的。所以需要利用Xcode的库和头文件。做法很简单：</div>
<div>在~/.bash_profile这个文件里添加这么一句话：alias gcc=&#8220;gcc &#8212;sysroot=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.7.sdk/&#8221;</div>
<div>这样在使用gcc编译的时候，就会自动到sysroot指定的目录下去查找头文件和库。至于sysroot是什么，建议你gcc &#8212;help一下，如果看不懂，再google吧。</div>
<div>     ok，这样就能使用gcc来编译了。 接下来，就是搞binutils了。</div>
<div>     从gnu的官网上下载binutils：<a href="http://ftp.gnu.org/gnu/binutils/">http://ftp.gnu.org/gnu/binutils/</a> 。不过很可惜，到目前为止，我还没有编译成功。:-)</div>
<div>     接下来我的思路是，1）继续尝试编译binutils 2）看看Xcode里面是否有反汇编工具，目前我最迫切需要的就是一个反汇编工具。很汗颜的是，仅仅需要一个反汇编工具，我就打算把bintuisl整个给弄到MacOS上&#8230;</div>
<div> </div>
<div>     说完了我之前做的一些尝试后，就开始李大牛的思路吧：对比分析darwin kernel。关于darwin kernel的一些文档在这个网址：<a href="https://developer.apple.com/library/mac/#documentation/MacOSX/Conceptual/OSX_Technology_Overview/SystemTechnology/SystemTechnology.html">https://developer.apple.com/library/mac/#documentation/MacOSX/Conceptual/OSX_Technology_Overview/SystemTechnology/SystemTechnology.html</a></div>
<div>    敬请期待…</div>
		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-05-03T00:00:00+08:00" pubdate data-updated="true">May 3<span>rd</span>, 2012</time></div>
	<div class="tags">

</div>
	
</div>
</article>  

<nav id="pagenavi">
    
        <a href="/blog/page/2/" class="prev">Prev</a>
    
    
        <a href="/blog/page/4/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

&#8211;>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Yafang Shao

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'laoar';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





</body>
</html>